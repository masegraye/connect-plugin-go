// Code generated by protoc-gen-connect-plugin. DO NOT EDIT.

// source: kv.proto

package kvv1delegate

import (
	"context"
	"net/http"

	"connectrpc.com/connect"
	kvv1 "github.com/masegraye/connect-plugin-go/testdata/kv/gen"
	kvv1connect "github.com/masegraye/connect-plugin-go/testdata/kv/gen/kvv1connect"
)

// KV is the domain interface for KVService.
type KV interface {
	// Get retrieves a value by key.
	Get(ctx context.Context, key string) (value []byte, found bool, err error)
	// Put stores a key-value pair.
	Put(ctx context.Context, key string, value []byte) error
	// Delete removes a key.
	Delete(ctx context.Context, key string) (found bool, err error)
	// Watch streams changes to keys with the given prefix.
	Watch(ctx context.Context, prefix string) (*connect.ServerStreamForClient[kvv1.WatchEvent], error)
}

// kVDelegate implements KV using a Connect client.
type kVDelegate struct {
	client kvv1connect.KVServiceClient
}

var _ KV = (*kVDelegate)(nil)

// New creates a KV from an existing Connect client.
func New(client kvv1connect.KVServiceClient) KV {
	return &kVDelegate{client: client}
}

// NewFromURL creates a KV from a URL.
func NewFromURL(url string, opts ...connect.ClientOption) KV {
	client := kvv1connect.NewKVServiceClient(http.DefaultClient, url, opts...)
	return &kVDelegate{client: client}
}

// Get implements Get via Connect client.
func (d *kVDelegate) Get(ctx context.Context, key string) (value []byte, found bool, err error) {
	req := &kvv1.GetRequest{
		Key: key,
	}

	resp, err := d.client.Get(ctx, connect.NewRequest(req))
	if err != nil {
		return nil, false, err
	}

	return resp.Msg.Value, resp.Msg.Found, nil
}

// Put implements Put via Connect client.
func (d *kVDelegate) Put(ctx context.Context, key string, value []byte) error {
	req := &kvv1.PutRequest{
		Key:   key,
		Value: value,
	}

	_, err := d.client.Put(ctx, connect.NewRequest(req))
	if err != nil {
		return err
	}

	return nil
}

// Delete implements Delete via Connect client.
func (d *kVDelegate) Delete(ctx context.Context, key string) (found bool, err error) {
	req := &kvv1.DeleteRequest{
		Key: key,
	}

	resp, err := d.client.Delete(ctx, connect.NewRequest(req))
	if err != nil {
		return false, err
	}

	return resp.Msg.Found, nil
}

// Watch implements Watch via Connect client.
func (d *kVDelegate) Watch(ctx context.Context, prefix string) (*connect.ServerStreamForClient[kvv1.WatchEvent], error) {
	req := &kvv1.WatchRequest{
		Prefix: prefix,
	}

	return d.client.Watch(ctx, connect.NewRequest(req))
}
